# Session: Idle Talk with Knowledge DB Integration

**Date**: 2025-10-17
**Branch**: `feature/idle-talk-with-knowledge-db`
**Status**: Phase 1 Completed

## Overview

Implemented an idle talk feature for the stage-web application that automatically initiates conversations when there's no user input for a specified time period. The feature integrates with the Knowledge DB to select random topics and generate contextual responses.

## Objectives

1. Implement timer-based idle detection in stage-web
2. Integrate with Knowledge DB for random topic retrieval
3. Generate automatic LLM responses with TTS playback
4. Make the feature configurable via environment variables
5. Ensure the character appears to be speaking spontaneously

## Implementation Details

### Architecture

The implementation follows a composable-based architecture:

```
User Inactivity
    â†“
Idle Timer (configurable timeout)
    â†“
Knowledge DB Random Topic Query
    â†“
LLM Response Generation (with topic as user message)
    â†“
TTS Pipeline & Audio Playback
    â†“
Remove prompt from chat history
    â†“
Display only assistant's response
```

### Key Components

#### 1. Knowledge DB API Enhancement

**File**: `services/knowledge-db/src/index.ts`

Added `/knowledge/random` endpoint:
- Returns random posts using PostgreSQL's `RANDOM()` function
- Supports `limit` parameter (default: 5)
- Supports optional `source` filter
- Only returns posts with embeddings (valid content)

```typescript
app.get('/knowledge/random', async (req, res) => {
  const { limit = 5, source } = req.query
  let query = db
    .select({...})
    .from(postsTable)
    .where(sql`${postsTable.content_vector_1536} IS NOT NULL`)
    .orderBy(sql`RANDOM()`)
    .limit(Number(limit))

  if (source) {
    query = query.where(eq(postsTable.source, source as string))
  }

  const posts = await query
  res.json({ posts, total: posts.length })
})
```

#### 2. Knowledge DB Composable Extension

**File**: `apps/stage-web/src/composables/useKnowledgeDB.ts`

Added `getRandomTopic()` method:
- Fetches random posts from Knowledge DB
- Configurable limit and source filter
- Returns array of posts with content and metadata

#### 3. Idle Talk Composable

**File**: `apps/stage-web/src/composables/idle-talk.ts` (new file)

Core features:
- **Timer-based idle detection**: Monitors user inactivity
- **Random topic selection**: Fetches topics from Knowledge DB
- **LLM integration**: Generates responses using chat store
- **Prompt injection**: Sends topic as user message, then removes from history
- **Hook coordination**: Uses `isCurrentlyIdleTalking` flag to skip Knowledge DB queries during idle talk

Key implementation pattern:
```typescript
// Export global flag for coordination
export const isCurrentlyIdleTalking = ref(false)

async function handleIdleTimeout() {
  isCurrentlyIdleTalking.value = true

  // Get random topic
  const randomTopic = await getRandomTopic()

  // Build user prompt
  const userPrompt = buildIdleTalkPrompt(randomTopic)

  // Send to LLM (triggers TTS pipeline)
  await chatStore.send(userPrompt, {...})

  // Remove prompt from history
  chatStore.messages.splice(promptIndex, 1)

  isCurrentlyIdleTalking.value = false
}
```

#### 4. Knowledge DB Hook Modification

**File**: `apps/stage-web/src/pages/index.vue`

Modified to skip Knowledge DB queries during idle talk:
```typescript
import { isCurrentlyIdleTalking } from '../composables/idle-talk'

chatStore.onBeforeMessageComposed(async (userMessage: string) => {
  // Skip Knowledge DB query during idle talk
  if (isCurrentlyIdleTalking.value) {
    console.info('[index.vue] Skipping Knowledge DB query (idle talk in progress)')
    return
  }

  // Normal Knowledge DB query
  const knowledgeResponse = await knowledgeDB!.queryKnowledge(userMessage)
  // ...
}, { persistent: true })
```

#### 5. App Initialization

**File**: `apps/stage-web/src/App.vue`

Initialize idle talk with environment variables:
```typescript
const idleTalkEnabled = import.meta.env.VITE_IDLE_TALK_ENABLED === 'true'
const idleTalkTimeout = Number(import.meta.env.VITE_IDLE_TIMEOUT || 60000)

if (idleTalkEnabled) {
  const idleTalk = useIdleTalk({
    enabled: idleTalkEnabled,
    timeout: idleTalkTimeout,
    mode: idleTalkMode as 'random' | 'sequential',
    minSimilarity: idleTalkMinSimilarity,
  })
  idleTalk.initialize()
}
```

### Environment Variables

**File**: `apps/stage-web/.env.example`

```env
# Idle Talk Configuration
VITE_IDLE_TALK_ENABLED=false          # Enable/disable idle talk feature
VITE_IDLE_TIMEOUT=60000               # Idle timeout in milliseconds (60s default)
VITE_IDLE_TALK_MODE=random            # Topic selection mode: random | sequential
VITE_IDLE_TALK_MIN_SIMILARITY=0.0     # Minimum similarity score (0-1)
```

### Makefile Enhancement

Added `db-restart` target for development:
```makefile
db-restart:
	@echo "ðŸ”„ Restarting knowledge-db service..."
	@pkill -f "knowledge-db.*tsx" || true
	@sleep 1
	@cd services/knowledge-db && pnpm start > /dev/null 2>&1 &
	@echo "âœ… Knowledge DB API server restarted"
```

## Technical Challenges & Solutions

### Challenge 1: Prompt Visibility in Chat

**Problem**: Initial implementation showed the prompt in the chat UI, breaking the illusion of spontaneous speech.

**Solution**: Send the topic as a user message, then remove it from chat history after the assistant responds. Only the assistant's response remains visible.

### Challenge 2: Knowledge DB Query on Idle Talk Trigger

**Problem**: The Knowledge DB hook was processing the idle talk prompt message, adding unwanted context.

**Solution**:
1. Export `isCurrentlyIdleTalking` ref from idle-talk composable
2. Import it in index.vue
3. Skip Knowledge DB query when `isCurrentlyIdleTalking.value === true`

### Challenge 3: System Message Modification Not Working

**Problem**: Initially tried to modify the system message to inject the topic, but the LLM ignored it due to:
- Vue reactivity issues with `chatStore.messages[0]`
- `toRaw()` processing in chat store
- `systemPrompt` watcher potentially overwriting changes

**Solution**: Changed approach to send the topic as a user message instead of modifying the system message. This ensures the LLM sees the topic context directly.

### Challenge 4: Audio Playback

**Issue**: Browser AudioContext requires user gesture to start.

**Solution**: The existing implementation already handles this - AudioContext is initialized on first user interaction with the page.

## Testing

### Test Scenarios

1. âœ… Idle timeout triggers after configured time
2. âœ… Random topic selected from Knowledge DB
3. âœ… LLM generates contextual response about the topic
4. âœ… TTS and audio playback work correctly
5. âœ… Prompt message removed from chat history
6. âœ… Only assistant's response visible in chat
7. âœ… Timer resets on user interaction
8. âœ… Knowledge DB query skipped during idle talk
9. âœ… Feature can be disabled via .env

### Test Configuration

For testing, use shorter timeout:
```env
VITE_IDLE_TALK_ENABLED=true
VITE_IDLE_TIMEOUT=10000  # 10 seconds for testing
```

## Files Modified

### New Files
- `apps/stage-web/src/composables/idle-talk.ts`
- `.claude-notes/sessions/2025-10-17-idle-talk.md`

### Modified Files
- `services/knowledge-db/src/index.ts` - Added `/knowledge/random` endpoint
- `services/knowledge-db/README.md` - Documented new endpoint
- `apps/stage-web/src/composables/useKnowledgeDB.ts` - Added `getRandomTopic()` method
- `apps/stage-web/src/pages/index.vue` - Skip Knowledge DB during idle talk
- `apps/stage-web/src/App.vue` - Initialize idle talk feature
- `apps/stage-web/.env.example` - Added idle talk configuration
- `apps/stage-web/README.md` - Updated feature list
- `Makefile` - Added `db-restart` target
- `CLAUDE.md` - Updated implementation status

## Future Enhancements (Phase 2)

1. **Sequential Mode**: Implement sequential topic selection to avoid repetition
2. **Topic History**: Track discussed topics to prevent immediate repeats
3. **Similarity Filtering**: Use `minSimilarity` parameter for topic relevance
4. **Emotion Detection**: Analyze topic sentiment for appropriate emotion display
5. **Multi-source Support**: Allow filtering topics by source (Discord, Twitter, etc.)
6. **Adaptive Timing**: Adjust idle timeout based on viewer activity patterns
7. **Topic Categories**: Support topic categorization for themed conversations

## Lessons Learned

1. **Vue Reactivity**: Direct mutation of reactive objects can have unexpected behavior; prefer immutable updates or explicit API methods
2. **Hook Coordination**: Global refs can be effective for coordinating state across composables
3. **Message History Management**: Careful manipulation of chat history is needed to create natural-looking conversations
4. **LLM Context Injection**: User messages are more reliable than system message modification for injecting context

## References

- [Knowledge DB Service](../../services/knowledge-db/README.md)
- [Stage UI Architecture](../../packages/stage-ui/README.md)
- [Environment Configuration](../../apps/stage-web/.env.example)
- [Same VTG AITuber Reference](https://github.com/tegnike/aituber-kit) - Python implementation inspiration

---

**Session Completed**: 2025-10-17
**Next Steps**: Phase 2 enhancements (optional)
